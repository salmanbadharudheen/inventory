{% extends 'base.html' %}
{% load humanize %}

{% block page_title %}Depreciation Report{% endblock %}

{% block extra_css %}
<style>
    .depr-header { display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-bottom:1.5rem; }
    .depr-actions { display:flex; gap:0.5rem; align-items:center; }
    .depr-cards { display:grid; grid-template-columns: repeat(3, 1fr); gap:1rem; margin-bottom:1.25rem; }
    .depr-card { background: white; border: 1px solid var(--border-color); padding:1rem; border-radius:8px; }
    .depr-card .stat-label { display:block; color:var(--text-secondary); font-size:0.85rem; }
    .depr-card .stat-value { font-weight:800; font-size:1.05rem; margin-top:0.25rem; }

    .depr-table { width:100%; border-collapse:collapse; font-size:0.95rem; }
    .depr-table thead th { background:#F8FAFC; padding:12px 16px; text-align:left; font-weight:700; color:var(--text-secondary); border-bottom:1px solid var(--border-color); }
    .depr-table td { padding:12px 16px; border-bottom:1px solid var(--border-color); vertical-align:middle; }
    .depr-table tbody tr:hover { background: #FBFDFF; }
    .depr-right { text-align:right; white-space:nowrap; }

    .depr-export { background: white; border:1px solid var(--border-color); padding:0.4rem 0.7rem; border-radius:8px; color:var(--text-secondary); text-decoration:none; }

    @media (max-width:900px) { .depr-cards { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block content %}
<div class="depr-header">
    <div>
        <h2 style="margin:0;">Financial Depreciation Report</h2>
        <p style="color: var(--text-secondary); margin:0.25rem 0 0 0;">Consolidated view of asset valuations and accumulated depreciation.</p>
    </div>
    <div class="depr-actions">
        <form method="get" style="display:flex; gap:0.5rem; align-items:center;">
            <input type="hidden" name="view" value="depreciation">
            <input type="text" name="q" placeholder="Search report..." value="{{ request.GET.q }}" class="form-control" style="max-width:260px;">
            <button type="submit" class="btn btn-primary"><i data-lucide="search"></i></button>
            {% if request.GET.q %}
            <a href="?view=depreciation" class="btn" style="background: white; border: 1px solid var(--border-color);">Clear</a>
            {% endif %}
        </form>
        <a href="{% url 'asset-export-excel' %}?{% if query_params %}{{ query_params }}{% else %}view=depreciation{% endif %}" class="depr-export" title="Export current report">Export Excel</a>
    </div>
</div>

<!-- Summary Cards -->
<div class="depr-cards">
    <div class="depr-card">
        <span class="stat-label">Total Purchase Cost</span>
        <span class="stat-value">AED {{ total_cost|floatformat:2|intcomma }}</span>
    </div>
    <div class="depr-card">
        <span class="stat-label">Accumulated Depreciation</span>
        <span class="stat-value" style="color:#991b1b;">AED {{ total_acc_dep|floatformat:2|intcomma }}</span>
    </div>
    <div class="depr-card">
        <span class="stat-label">Net Book Value (NBV)</span>
        <span class="stat-value" style="color:var(--primary);">AED {{ total_nbv|floatformat:2|intcomma }}</span>
    </div>
</div>

<div class="card" style="padding: 0; overflow-x:auto;">
    <table class="depr-table">
        <thead style="background: #F8FAFC;">
            <tr style="border-bottom: 2px solid var(--border-color);">
                <th style="padding:1rem;">Asset Information</th>
                <th style="padding:1rem;">Method</th>
                <th style="padding:1rem; text-align: center;">Life</th>
                <th style="padding:1rem;">Purchased</th>
                <th class="depr-right">Cost</th>
                <th class="depr-right">Acc. Depr.</th>
                <th class="depr-right">Current NBV</th>
            </tr>
        </thead>
        <tbody>
            {% for asset in assets %}
            <tr style="border-bottom:1px solid var(--border-color);">
                <td style="padding:1rem;">
                    <a href="{% url 'asset-detail' asset.pk %}" style="text-decoration: none; color: inherit;">
                        <div style="font-weight: 600;">{{ asset.name }}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">{{ asset.asset_tag }} • {{ asset.category.name }}</div>
                    </a>
                </td>
                <td style="padding:1rem;">
                    <span style="font-size: 0.85rem; color: var(--text-secondary);">{{ asset.get_depreciation_method_display }}</span>
                </td>
                <td style="padding:1rem; text-align: center;">{{ asset.useful_life_years }}Y</td>
                <td style="padding:1rem;">{{ asset.purchase_date|date:"M d, Y"|default:"-" }}</td>
                <td class="depr-right">{{ asset.currency }} {{ asset.purchase_price|floatformat:2|intcomma }}</td>
                <td class="depr-right" style="color:#991b1b;">-{{ asset.currency }} {{ asset.accumulated_depreciation|floatformat:2|intcomma }}</td>
                <td class="depr-right" style="font-weight:600; color:var(--primary);">{{ asset.currency }} {{ asset.current_value|floatformat:2|intcomma }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                    No financial data available for the current selection.
                </td>
            </tr>
            {% endfor %}
        </tbody>
        {% if assets %}
        <tfoot style="background: #F8FAFC; border-top: 2px solid var(--border-color);">
            <tr style="font-weight: 700;">
                <td colspan="4" style="padding:1rem; text-align: right;">TOTALS</td>
                <td style="padding:1rem; text-align: right;">AED {{ total_cost|floatformat:2|intcomma }}</td>
                <td style="padding:1rem; text-align: right; color: #991b1b;">-AED {{
                    total_acc_dep|floatformat:2|intcomma }}</td>
                <td style="padding:1rem; text-align: right; color: var(--primary); font-size: 1.1rem;">AED {{
                    total_nbv|floatformat:2|intcomma }}</td>
            </tr>
        </tfoot>
        {% endif %}
    </table>
</div>

{% if is_paginated %}
<div style="margin-top: 1.5rem; display: flex; justify-content: center; gap: 0.5rem;">
    {% if page_obj.has_previous %}
    <a href="?{% if query_params %}{{ query_params }}&{% endif %}page={{ page_obj.previous_page_number }}" class="btn" style="background: white; border: 1px solid var(--border-color);">&laquo; Previous</a>
    {% endif %}

    <span style="padding: 0.5rem 1rem; color: var(--text-secondary);">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
    <a href="?{% if query_params %}{{ query_params }}&{% endif %}page={{ page_obj.next_page_number }}" class="btn" style="background: white; border: 1px solid var(--border-color);">Next &raquo;</a>
    {% endif %}
</div>
{% endif %}

{% endblock %}